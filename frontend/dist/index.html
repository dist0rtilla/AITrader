<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AITrader Control Panel</title>
    <link rel="stylesheet" href="/ui/styles.css" />

    <!-- compact tile styles for the monitor -->
    <style>
      .grid { display: grid; grid-template-columns: 1fr 1fr 360px; gap: 18px; align-items: start; }
      .tile { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); padding: 14px; border-radius: 12px; box-shadow: 0 4px 14px rgba(3,7,18,0.35); }
      .tile h3 { margin: 0 0 8px 0; font-size: 16px; }
      .kv { display:flex; justify-content:space-between; align-items:center; }
      .components-grid { display:grid; grid-template-columns: repeat(1, 1fr); gap:10px; }
      @media(min-width:1100px){ .components-grid { grid-template-columns: repeat(2, 1fr); } }
      .status-on { background:#10b981;padding:6px 10px;border-radius:999px;color:#042; font-weight:600 }
      .status-off { background:#ef4444;padding:6px 10px;border-radius:999px;color:#fff;font-weight:600 }
      .badge { background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px }
      .proc-meta { color: #9aa4b2; font-size: 13px }
      .progress-outer { background: rgba(255,255,255,0.03); height:10px;border-radius:8px; overflow:hidden }
      .progress-inner { height:10px;border-radius:8px;background:linear-gradient(90deg,#06f,#4f46e5); }
      .gpu-usage { display:flex;justify-content:space-between;align-items:center }
      .small { color:#9aa4b2; font-size:13px }
      code { background: rgba(255,255,255,0.02); padding:2px 6px;border-radius:6px;font-size:12px }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">AI</div>
        <div>
          <h1>AITrader Control Panel</h1>
          <div class="small">Realtime system monitor & control</div>
        </div>
      </header>

      <div style="display:flex;gap:12px;margin-bottom:12px">
        <a class="btn" href="/ui/monitor.html">Live Monitor</a>
        <a class="btn" href="/ui/execution.html">Execution Window</a>
        <a class="btn" href="/ui/strategies.html">Strategies</a>
        <a class="btn" href="/ui/database.html">Database</a>
        <a class="btn" href="/ui/settings.html">Settings</a>
      </div>

      <!-- layout changed: left / middle / right columns for snapshot / components / model -->
      <div class="grid">
        <div id="left-col">
          <div class="tile" id="card-snapshot">
            <h3>System Snapshot</h3>
            <div class="kv"><div class="small">Last update</div><div class="badge" id="ts">-</div></div>
            <div id="snapshot-human"></div>
          </div>
          <div class="tile" id="gpus-tile" style="margin-top:12px">
            <h3>GPUs</h3>
            <div id="gpus-area">loading...</div>
          </div>
        </div>

        <div id="middle-col">
          <div class="tile">
            <h3>Components</h3>
            <div class="components-grid" id="components">loading...</div>
          </div>
        </div>

        <div id="right-col">
          <div class="tile">
            <h3>AI Model Metrics</h3>
            <div id="model-metrics">loading...</div>
          </div>
        </div>
      </div>

      <div class="footer">Backend: <a href="/api/status">/api/status</a></div>
    </div>

    <script>
      function fmtBytes(n){ if(n==null) return '-'; const units=['B','KB','MB','GB']; let i=0; while(n>=1024 && i<units.length-1){ n/=1024; i++ } return n.toFixed(i?2:0)+' '+units[i] }
      function fmtLoad(load){ if(!load) return '-'; return `1m ${load[0].toFixed(2)}, 5m ${load[1].toFixed(2)}, 15m ${load[2].toFixed(2)}` }

      const leftCol = document.getElementById('left-col')
      const midCol = document.getElementById('middle-col')
      const rightCol = document.getElementById('right-col')
      const ts = document.getElementById('ts')
      const comps = document.getElementById('components')
      const modelDiv = document.getElementById('model-metrics')
      const gpusArea = document.getElementById('gpus-area')

      function progressHtml(pct){
        return `<div class='progress-outer'><div class='progress-inner' style='width:${pct}%' ></div></div>`
      }

      function gpuTile(g){
        const memPct = g.memory_total_mb? Math.round((g.memory_used_mb/g.memory_total_mb)*100) : 0
        return `<div style="padding:8px;border-radius:8px;background:transparent;display:flex;flex-direction:column;gap:6px"><div style='display:flex;justify-content:space-between;align-items:center'><div><b>${g.name}</b><div class='small'>Memory: ${g.memory_used_mb}/${g.memory_total_mb} MB</div></div><div style='text-align:right'><div class='small'>Util ${g.utilization_percent}%</div><div class='small'>Mem ${memPct}%</div></div></div>${progressHtml(g.utilization_percent)}</div>`
      }

      function procTile(k,v){
        const status = v.running? `<span class='status-on'>running</span>` : `<span class='status-off'>down</span>`
        const rss = v.rss_kb? fmtMBFromKB(v.rss_kb) : '-' 
        const cmd = v.cmd? `<div class='proc-meta'>${escapeHtml(truncate(v.cmd, 80))}</div>` : ''
        return `<div class='tile' style='display:flex;justify-content:space-between;align-items:flex-start'><div><b>${k}</b><div class='proc-meta'>pid: ${v.pid||'-'} • cpu: ${v.cpu_percent||'-'}% • mem: ${v.mem_percent||'-'}% • rss: ${rss}</div>${cmd}</div><div>${status}</div></div>`
      }

      function escapeHtml(s){ if(!s) return '' ; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
      function truncate(s,n){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…': s }
      function fmtMBFromKB(kb){ if(!kb && kb!==0) return '-'; return Math.round(kb/1024)+' MB' }

      function renderSnapshot(j){
        const snapDiv = document.getElementById('snapshot-human')
        snapDiv.innerHTML = ''
        const db = j.components && j.components.database
        const dbHtml = `<div class='kv'><div class='small'>Database</div><div>${db && db.path?db.path:'(none)'} ${db && db.size_bytes?(' — '+fmtBytes(db.size_bytes)):''}</div></div>`
        const load = j.system && j.system.loadavg || [0,0,0]
        const cores = j.system && j.system.cores || 1
        const pct1 = Math.min(100, Math.round((load[0] / Math.max(1, cores)) * 100))
        const pct5 = Math.min(100, Math.round((load[1] / Math.max(1, cores)) * 100))
        const pct15 = Math.min(100, Math.round((load[2] / Math.max(1, cores)) * 100))
        const loadHtml = `<div class='small'>System Load</div><div class='small'>${fmtLoad(load)}</div><div style='margin-top:8px'>1m ${pct1}% ${progressHtml(pct1)}</div><div style='margin-top:6px'>5m ${pct5}% ${progressHtml(pct5)}</div><div style='margin-top:6px'>15m ${pct15}% ${progressHtml(pct15)}</div><div class='small' style='margin-top:8px'>${pct1}% of ${cores} cores (1m)</div>`

        snapDiv.innerHTML = dbHtml + '<div style="height:10px"></div>' + loadHtml

        // GPUs handled separately
        const gpus = j.gpus || []
        if(gpus.length){
          gpusArea.innerHTML = ''
          for(const g of gpus){ gpusArea.innerHTML += gpuTile(g) }
        } else {
          gpusArea.innerHTML = `<div class='small'>No NVIDIA GPUs detected or nvidia-smi unavailable.</div>`
        }
      }

      function renderComponents(j){
        comps.innerHTML = ''
        const items = j.components || {}
        // render each component as a tile in the grid
        let html = ''
        for(const [k,v] of Object.entries(items)){
          // skip database and onnx_runner here (they get their own cards)
          if(k==='database' || k==='onnx_runner') continue
          html += procTile(k,v)
        }
        if(!html) html = '<div class="small">No running components detected.</div>'
        comps.innerHTML = html
      }

      function renderModelMetrics(j){
        const mm = j.model_metrics || {}
        let html = ''
        html += `<div class='small'>Selected model: <b>${mm.model||'none'}</b></div>`
        if(mm.model_path) html += `<div class='small' style='margin-top:6px'>Path: <code title='${mm.model_path}'>${truncate(mm.model_path,40)}</code></div>`
        if(mm.onnx_providers && mm.onnx_providers.length){ html += `<div class='small' style='margin-top:8px'><b>Providers</b>: ${mm.onnx_providers.slice(0,6).join(', ')}${mm.onnx_providers.length>6? '...':''}</div>` }
        const active = mm.active_provider || (j.components && j.components.onnx_runner && j.components.onnx_runner.active_provider)
        if(active) html += `<div class='small' style='margin-top:8px'>Active provider: <b>${Array.isArray(active)? active.join(',') : active}</b> ${/cpu/i.test(String(active))?"<span style='color:#f59e0b'>(CPU only)</span>":""}</div>`
        if(mm.last_inference_ms) html += `<div class='small' style='margin-top:6px'>Last inference time: <b>${mm.last_inference_ms} ms</b></div>`
        if(mm.last_probe_ms) html += `<div class='small' style='margin-top:6px'>Last probe latency: <b>${mm.last_probe_ms} ms</b></div>`

        // include onnx_runner quick summary
        if(j.components && j.components.onnx_runner){
          const or = j.components.onnx_runner
          html += `<div class='small' style='margin-top:10px'>ONNX Runner: <a href='${or.url}' target='_blank'>${or.url}</a> • status: ${or.status_code||or.error||'n/a'}`
          if(or.latency_ms) html += ` • probe: ${or.latency_ms} ms`
          html += `</div>`
        }

        modelDiv.innerHTML = html
      }

      // resilient websocket with reconnect
      let ws = null
      function connectWS(){
        if(ws){ try{ ws.close() }catch(e){} }
        ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/api/ws/monitor')
        ws.onmessage = (e)=>{
          try{
            const j = JSON.parse(e.data)
            ts.textContent = new Date(j.ts*1000).toLocaleString()
            renderSnapshot(j)
            renderComponents(j)
            renderModelMetrics(j)
          }catch(err){console.error(err)}
        }
        ws.onopen = ()=>console.log('ws open')
        ws.onclose = ()=>{ console.log('ws closed, reconnecting in 1s'); setTimeout(connectWS, 1000) }
        ws.onerror = (e)=>{ console.warn('ws error', e); ws.close() }
      }
      connectWS()
    </script>
  </body>
</html>